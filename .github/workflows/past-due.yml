name: Ping Past Due Issues

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  past-due:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Generate App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Check all issues for past-due
        uses: actions/github-script@v7
        env:
          PROJECT_NUMBER: ${{ vars.PROJECT_NUMBER }}
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const projectNumber = Number(process.env.PROJECT_NUMBER);

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner: context.repo.owner, repo: context.repo.repo, state: "open" }
            );

            for (const issue of issues) {
              const q = await github.graphql(`
                query($owner: String!, $repo: String!, $issue: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issue) {
                      projectItems(first: 10) {
                        nodes {
                          project { ... on ProjectV2 { number } }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldDateValue {
                                field {
                                  ... on ProjectV2Field { name }
                                }
                                date
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue: issue.number
              });

              const items = q.repository.issue.projectItems.nodes;
              if (!items || items.length === 0) continue;

              const item = items.find(i => i.project?.number === projectNumber);
              if (!item) continue;

              const target = item.fieldValues.nodes.find(f => f.field?.name === "Target Date")?.date;
              if (!target) continue;

              const targetDate = new Date(target);
              const now = new Date();

              if (now > targetDate && issue.assignees && issue.assignees.length > 0) {
                const pings = issue.assignees.map(a => '@' + a.login).join(' ');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `${pings} This issue is past its target date (${target}). Please provide a status update.`
                });
              }
            }
