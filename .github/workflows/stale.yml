name: Mark Stale Issues

on:
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

jobs:
  mark-stale:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Generate App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Process Stale Issues
        uses: actions/github-script@v7
        env:
          PROJECT_NUMBER: ${{ vars.PROJECT_NUMBER }}
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const projectNumber = Number(process.env.PROJECT_NUMBER);
            const now = new Date();
            
            // Define thresholds
            const DAYS_DEFAULT = 14;
            const DAYS_LONG = 30;

            // Fetch all open issues
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner: context.repo.owner, repo: context.repo.repo, state: "open" }
            );

            console.log(`Found ${issues.length} open issues. Starting checks...`);

            for (const issue of issues) {
              try {
                // Skip if already stale
                if (issue.labels.some(l => l.name === "stale")) continue;

                // 1. Determine Threshold based on label
                const days = issue.labels.some(l => l.name === 'long-task') ? DAYS_LONG : DAYS_DEFAULT;
                const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                
                // 2. Check Last Update Time
                const updated = new Date(issue.updated_at);
                if (updated >= cutoff) continue; // It is active, skip it

                // 3. GraphQL Check: Project Start Date & Child Activity
                const query = `
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        projectItems(first: 10) {
                          nodes {
                            project { number }
                            fieldValues(first: 20) {
                              nodes {
                                ... on ProjectV2ItemFieldDateValue {
                                  field { ... on ProjectV2FieldCommon { name } }
                                  date
                                }
                              }
                            }
                          }
                        }
                        trackedIssues(first: 20) {
                          nodes {
                            updatedAt
                            trackedIssues(first: 10) {
                              nodes { updatedAt }
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const data = await github.graphql(query, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: issue.number
                });

                // --- CHECK 3a: Start Date ---
                const pItems = data.repository.issue.projectItems.nodes;
                const projectItem = pItems.find(i => i.project?.number === projectNumber);
                
                if (projectItem) {
                  const startDateStr = projectItem.fieldValues.nodes.find(f => f.field?.name === "Start Date")?.date;
                  if (startDateStr) {
                    const startDate = new Date(startDateStr);
                    if (startDate > now) continue; // Start date in future, skip
                  }
                }

                // --- CHECK 3b: Active Children ---
                let hasActiveChild = false;
                const children = data.repository.issue.trackedIssues.nodes;
                
                // Check direct children
                if (children.some(child => new Date(child.updatedAt) >= cutoff)) {
                  hasActiveChild = true;
                } else {
                  // Check grandchildren
                  hasActiveChild = children.some(child => 
                    child.trackedIssues.nodes.some(grandChild => new Date(grandChild.updatedAt) >= cutoff)
                  );
                }

                if (hasActiveChild) continue; // Children active, skip

                // --- ACTION: Mark Stale ---
                console.log(`Marking issue #${issue.number} as stale.`);
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ["stale"]
                });

                if (issue.assignee) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `@${issue.assignee.login} This issue has gone stale. Please update or comment to keep it active.`
                  });
                }

              } catch (error) {
                console.log(`Error processing #${issue.number}: ${error.message}`);
              }
            }

  remove-stale-on-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'

    permissions:
      issues: write

    steps:
      - name: Generate App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Remove stale label when comment added
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const issue = context.payload.issue;
            if (issue.labels.some(l => l.name === "stale")) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: "stale"
              });
            }
